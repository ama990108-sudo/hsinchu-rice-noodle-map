<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æ–°ç«¹ç±³ç²‰åœ°åœ– | Hsinchu Rice Noodle Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif;background:#faf7f2;color:#222}
header{background:#c62828;color:#fff;padding:14px 18px;display:flex;align-items:center}
header h1{margin:0;font-size:1.2rem}
header .spacer{flex:1}
header button{background:#fff;color:#c62828;border:none;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer}
#map{height:62vh}
.panel{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:14px;margin:14px}
.star span{cursor:pointer;font-size:1.2rem;color:#ccc}
.star span.active{color:#f6b400}
</style>
</head>

<body>

<header>
<h1>æ–°ç«¹ç±³ç²‰åœ°åœ–</h1>
<div class="spacer"></div>
</header>

<div id="map"></div>

<div class="panel">
<h3>ğŸ“ æˆ‘è¦è©•åˆ†</h3>
<a href="ã€åœ¨é€™è£¡è²¼ä½ çš„ Google è¡¨å–®é€£çµã€‘" target="_blank">
ğŸ‘‰ é»æˆ‘å¡«å¯« Google è¡¨å–®ï¼ˆå½±éŸ¿å…¬é–‹å¹³å‡ï¼‰
</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const shops=[
{id:"dongmen",name:"æ±é–€ç±³ç²‰æ”¤",lat:24.8046,lng:120.9715,g:"https://www.google.com/maps/search/?api=1&query=æ±é–€ç±³ç²‰æ”¤ æ–°ç«¹"},
{id:"acheng",name:"é˜¿åŸç±³ç²‰",lat:24.8039,lng:120.9659,g:"https://www.google.com/maps/search/?api=1&query=é˜¿åŸç±³ç²‰ æ–°ç«¹"},
{id:"datong",name:"å¤§åŒç±³ç²‰æ¹¯",lat:24.8134,lng:120.9721,g:"https://www.google.com/maps/search/?api=1&query=å¤§åŒç±³ç²‰æ¹¯ æ–°ç«¹"},
{id:"dingpu",name:"é ‚åŸ”ç±³ç²‰æ¹¯",lat:24.76091,lng:120.92934,g:"https://www.google.com/maps/place/é ‚åŸ”ç±³ç²‰æ¹¯"}
];

const map=L.map("map").setView([24.8039,120.9698],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ===== æœ¬æ©Ÿè©•åˆ† ===== */
function getLocal(id){
return Number(localStorage.getItem("rate_"+id)||0);
}
function setLocal(id,v){
localStorage.setItem("rate_"+id,v);
}

/* ===== æ˜Ÿæ˜Ÿ UI ===== */
function starHTML(id){
let v=getLocal(id);
let h='<div class="star" data-id="'+id+'">';
for(let i=1;i<=5;i++){
h+=`<span class="${i<=v?'active':''}">â˜…</span>`;
}
h+='</div>';
return h;
}

/* ===== å…¬é–‹å¹³å‡ ===== */
let publicRate={};

fetch("ã€åœ¨é€™è£¡è²¼ Google Sheets CSV é€£çµã€‘")
.then(r=>r.text())
.then(t=>{
const rows=t.trim().split("\n").slice(1);
rows.forEach(r=>{
const [id,s]=r.split(",");
if(!publicRate[id])publicRate[id]={sum:0,count:0};
publicRate[id].sum+=Number(s);
publicRate[id].count++;
});
});

/* ===== Popup ===== */
function popupContent(s){
const p=publicRate[s.id];
const avg=p?(p.sum/p.count).toFixed(1):"å°šç„¡";
const cnt=p?p.count:0;

return `
<b>${s.name}</b><br>
å…¬é–‹å¹³å‡ï¼šâ­ ${avg}ï¼ˆ${cnt} äººï¼‰<br>
ä½ çš„è©•åˆ†ï¼š${starHTML(s.id)}
<a href="${s.g}" target="_blank">Google Maps</a>
`;
}

/* ===== Marker ===== */
shops.forEach(s=>{
const m=L.marker([s.lat,s.lng]).addTo(map);
m.on("click",()=>{
m.bindPopup(popupContent(s)).openPopup();
map.setView([s.lat,s.lng],17);
setTimeout(()=>{
document.querySelectorAll(".star span").forEach((sp,i)=>{
sp.onclick=()=>{
setLocal(s.id,i+1);
m.bindPopup(popupContent(s)).openPopup();
};
});
},50);
});
});
</script>

</body>
</html>