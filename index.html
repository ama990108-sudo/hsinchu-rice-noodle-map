<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æ–°ç«¹ç±³ç²‰åœ°åœ–</title>

<!-- âœ… Leaflet CSSï¼ˆä¸€å®šè¦æœ‰ï¼‰ -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif;
  background:#faf7f2;
}
header{
  background:#c62828;
  color:#fff;
  padding:12px 16px;
  display:flex;
  align-items:center;
}
header h1{margin:0;font-size:1.2rem}
header .spacer{flex:1}
header button{
  background:#fff;
  color:#c62828;
  border:none;
  border-radius:20px;
  padding:6px 14px;
  font-weight:700;
  cursor:pointer;
}
#map{
  height:520px;
  width:100%;
}
main{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
.panel{
  background:#fff;
  border-radius:16px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  padding:16px;
  margin-bottom:16px;
}
.item{
  border-left:6px solid #c62828;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px;
}
.footer{
  text-align:center;
  font-size:.85rem;
  color:#666;
  margin:20px 0;
}
</style>
</head>

<body>

<header>
  <h1 id="title">æ–°ç«¹ç±³ç²‰åœ°åœ–</h1>
  <div class="spacer"></div>
  <button id="langBtn">EN</button>
</header>

<div id="map"></div>

<main>
  <section class="panel">
    <h2 id="rateTitle">ğŸœ åº—å®¶åˆ—è¡¨</h2>
    <div id="shopList"></div>
  </section>

  <section class="panel">
    <h2 id="formTitle">ğŸ“ æˆ‘è¦è©•åˆ†</h2>
    <a
      href="https://docs.google.com/forms/d/e/1FAIpQLSc30CvEspcBPhKd2W_ylALFxNIFLKsiv2afyXhGM674qEzFVQ/viewform"
      target="_blank"
    >
      ğŸ‘‰ å‰å¾€ Google è¡¨å–®å¡«å¯«è©•åˆ†
    </a>
  </section>
</main>

<div class="footer">Â© Hsinchu Rice Noodle Map</div>

<!-- âœ… Leaflet JSï¼ˆä¸€å®šè¦åœ¨ script å‰ï¼‰ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
window.onload = function(){

/* ===== èªè¨€ ===== */
let lang = "zh";

/* ===== æ–°ç«¹ç«è»Šç«™ ===== */
const station = { lat:24.8019, lng:120.9715 };

/* ===== ç±³ç²‰å…¬æœƒä»‹ç´¹é ï¼ˆå¯è‡ªè¡Œæ›ç¶²å€ï¼‰ ===== */
const associationUrl = "https://www.hc-food.org.tw/article-detail.php?nid=16#æ–°ç«¹çš„ç±³ç²‰ï¼Œä¸åªæ˜¯ç±³ç²‰";

/* ===== åº—å®¶è³‡æ–™ ===== */
const shops = [
  { zh:"é˜¿åŸç±³ç²‰", en:"A-Cheng Rice Noodles", lat:24.8039, lng:120.9659 },
  { zh:"æ±é–€ç±³ç²‰æ”¤", en:"Dongmen Market Rice Noodles", lat:24.8046, lng:120.9715 },
  { zh:"è¥¿å¸‚ç±³ç²‰æ¹¯", en:"Xishi Rice Noodle Soup", lat:24.8042, lng:120.9689 },
  { zh:"çè¨˜ç±³ç²‰æ¹¯", en:"Zhen-Ji Rice Noodle Soup", lat:24.8071, lng:120.9712 }
];

/* ===== è·é›¢è¨ˆç®— ===== */
function distanceMeter(a, b){
  const R = 6371000;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;

  const x =
    Math.sin(dLat/2)**2 +
    Math.sin(dLng/2)**2 * Math.cos(lat1) * Math.cos(lat2);

  return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
}

function walkMinutes(shop){
  return Math.max(1, Math.round(distanceMeter(station, shop) / 60));
}

/* ===== åœ°åœ– ===== */
const map = L.map("map").setView([24.805,120.97],16);

L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom:19, detectRetina:true, attribution:"Â© OpenStreetMap" }
).addTo(map);

let markers = [];

/* ===== Marker ===== */
function renderMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  shops.forEach((s,i)=>{
    const name = lang==="zh"?s.zh:s.en;
    const mins = walkMinutes(s);

    const marker = L.marker([s.lat,s.lng]).addTo(map);

    marker.bindPopup(`
      <b>${name}</b><br>
      ${lang==="zh"?`ğŸš¶â€â™‚ï¸ æ­¥è¡Œç´„ ${mins} åˆ†é˜`:`ğŸš¶ ~${mins} min walk`}<br>
      <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}"
         target="_blank">Google Maps</a>
    `);

    marker.on("click",()=>{
      map.flyTo([s.lat,s.lng],18,{animate:true});
      marker.openPopup();
    });

    markers.push(marker);
  });
}

/* ===== æ’å…¥ç±³ç²‰å…¬æœƒä»‹ç´¹å€å¡Š ===== */
function insertAssociationBlock(){
  if(document.getElementById("associationBlock")) return;

  const block = document.createElement("section");
  block.id = "associationBlock";
  block.className = "panel";
  block.style.margin = "16px";

  block.innerHTML = `
    <h2>${lang==="zh"?"ğŸ“œ æ–°ç«¹ç±³ç²‰ç”¢æ¥­ä»‹ç´¹":"ğŸ“œ Hsinchu Rice Noodle Association"}</h2>
    <p>
      ${lang==="zh"
        ?"æƒ³æ›´æ·±å…¥äº†è§£æ–°ç«¹ç±³ç²‰çš„æ­·å²ã€è£½ä½œå·¥æ³•èˆ‡ç”¢æ¥­æ–‡åŒ–ï¼Œå¯åƒè€ƒæ–°ç«¹ç±³ç²‰å…¬æœƒçš„å®˜æ–¹ä»‹ç´¹é é¢ã€‚"
        :"Learn more about the history, craftsmanship, and culture of Hsinchu rice noodles."}
    </p>
    <a href="${associationUrl}" target="_blank"
       style="display:inline-block;margin-top:8px;font-weight:700;color:#c62828">
      ğŸ‘‰ ${lang==="zh"?"å‰å¾€ç±³ç²‰å…¬æœƒä»‹ç´¹":"Visit Official Introduction"}
    </a>
  `;

  const header = document.querySelector("header");
  header.after(block);
}

/* ===== èªè¨€ ===== */
function applyLang(){
  document.getElementById("title").textContent =
    lang==="zh"?"æ–°ç«¹ç±³ç²‰åœ°åœ–":"Hsinchu Rice Noodle Map";

  document.getElementById("rateTitle").textContent =
    lang==="zh"?"ğŸœ åº—å®¶åˆ—è¡¨":"ğŸœ Shop List";

  document.getElementById("formTitle").textContent =
    lang==="zh"?"ğŸ“ æˆ‘è¦è©•åˆ†":"ğŸ“ Rate a Shop";

  document.getElementById("langBtn").textContent =
    lang==="zh"?"EN":"ä¸­æ–‡";

  renderMarkers();
  insertAssociationBlock();

  document.getElementById("shopList").innerHTML =
    shops.map((s,i)=>{
      const name = lang==="zh"?s.zh:s.en;
      const mins = walkMinutes(s);
      return `
        <div class="item" style="cursor:pointer" onclick="focusShop(${i})">
          <b>${name}</b><br>
          <small>${lang==="zh"?`ğŸš¶â€â™‚ï¸ æ­¥è¡Œç´„ ${mins} åˆ†é˜`:`ğŸš¶ ~${mins} min walk`}</small>
        </div>
      `;
    }).join("");
}

/* ===== é»åˆ—è¡¨ ===== */
window.focusShop = function(i){
  map.flyTo([shops[i].lat,shops[i].lng],18,{animate:true});
  markers[i].openPopup();
};

document.getElementById("langBtn").onclick = ()=>{
  lang = lang==="zh"?"en":"zh";
  applyLang();
};

/* ===== å•Ÿå‹• ===== */
applyLang();

};
</script>
</body>
</html>