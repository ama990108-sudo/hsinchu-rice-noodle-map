<script>
window.onload = function(){

/* ===== èªè¨€ ===== */
let lang = "zh";

/* ===== åº—å®¶è³‡æ–™ ===== */
const shops = [
  {id:"acheng", zh:"é˜¿åŸç±³ç²‰", en:"A-Cheng Rice Noodles", lat:24.8039, lng:120.9659},
  {id:"dongmen", zh:"æ±é–€ç±³ç²‰æ”¤", en:"Dongmen Market Rice Noodles", lat:24.8046, lng:120.9715},
  {id:"xishi", zh:"è¥¿å¸‚ç±³ç²‰æ¹¯", en:"Xishi Rice Noodle Soup", lat:24.8042, lng:120.9689},
  {id:"zhenji", zh:"çè¨˜ç±³ç²‰æ¹¯", en:"Zhen-Ji Rice Noodle Soup", lat:24.8071, lng:120.9712}
];

/* ===== åœ°åœ–åˆå§‹åŒ– ===== */
const map = L.map("map").setView([24.805,120.97],15);

L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom:19,
    detectRetina:true,
    attribution:"Â© OpenStreetMap"
  }
).addTo(map);

/* ===== Marker ===== */
const markers = [];

function renderMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers.length = 0;

  shops.forEach(s => {
    const m = L.marker([s.lat, s.lng]).addTo(map);
    const name = lang === "zh" ? s.zh : s.en;

    m.bindPopup(`
      <b>${name}</b><br>
      <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}" target="_blank">
        Google Maps
      </a>
    `);

    m.on("click", () => {
      map.flyTo([s.lat, s.lng], 17, {animate:true});
      m.openPopup();
    });

    markers.push(m);
  });
}

/* ===== è©•åˆ†ï¼ˆGoogle Sheets CSVï¼‰ ===== */
function loadRatings(){
  fetch("ã€è²¼ä½ çš„ Google Sheets CSV é€£çµã€‘")
    .then(r => r.text())
    .then(t => {
      const rows = t.trim().split("\n").slice(1);
      const stat = {};

      rows.forEach(r => {
        const [id, star] = r.split(",");
        if(!stat[id]) stat[id] = {sum:0, count:0};
        stat[id].sum += Number(star);
        stat[id].count++;
      });

      document.getElementById("shopList").innerHTML =
        shops.map(s => {
          const d = stat[s.id];
          const avg = d ? (d.sum / d.count).toFixed(1) : "â€”";
          const cnt = d ? d.count : 0;
          return `
            <div class="item">
              <b>${lang === "zh" ? s.zh : s.en}</b><br>
              <span class="stars">â­ ${avg}</span>ï¼ˆ${cnt}ï¼‰
            </div>
          `;
        }).join("");
    });
}

/* ===== èªè¨€åˆ‡æ› ===== */
function applyLang(){
  document.getElementById("title").textContent =
    lang === "zh" ? "æ–°ç«¹ç±³ç²‰åœ°åœ–" : "Hsinchu Rice Noodle Map";

  document.getElementById("rateTitle").textContent =
    lang === "zh" ? "ğŸœ åº—å®¶è©•åˆ†" : "ğŸœ Ratings";

  document.getElementById("formTitle").textContent =
    lang === "zh" ? "ğŸ“ æˆ‘è¦è©•åˆ†" : "ğŸ“ Rate a Shop";

  document.getElementById("langBtn").textContent =
    lang === "zh" ? "EN" : "ä¸­æ–‡";

  renderMarkers();
  loadRatings();
}

document.getElementById("langBtn").onclick = () => {
  lang = lang === "zh" ? "en" : "zh";
  applyLang();
};

/* ===== å•Ÿå‹• ===== */
applyLang();

};
</script>